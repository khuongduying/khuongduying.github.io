[
  {
    "objectID": "tutorials.html",
    "href": "tutorials.html",
    "title": "khuongduying",
    "section": "",
    "text": "Back to top"
  },
  {
    "objectID": "Advance/cell2loc_A1_downstream.html",
    "href": "Advance/cell2loc_A1_downstream.html",
    "title": "select one slide for visualization",
    "section": "",
    "text": "import sys\nimport scanpy as sc\nimport squidpy as sq\nimport anndata\nimport pandas as pd\nimport numpy as np\nimport os\n\ndata_type = 'float32'\n\nimport cell2location as c2l\n\nimport matplotlib as mpl\nfrom matplotlib import rcParams\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nsc.settings.verbosity = 3\nsc.settings.set_figure_params(dpi=80, facecolor=\"white\")\n\n# silence scanpy that prints a lot of warnings\nimport warnings\nwarnings.filterwarnings('ignore')\n\n/opt/mambaforge/envs/cell2loc_env/lib/python3.9/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html\n  from .autonotebook import tqdm as notebook_tqdm\n/opt/mambaforge/envs/cell2loc_env/lib/python3.9/site-packages/scvi/_settings.py:63: UserWarning: Since v1.0.0, scvi-tools no longer uses a random seed by default. Run `scvi.settings.seed = 0` to reproduce results from previous versions.\n  self.seed = seed\n/opt/mambaforge/envs/cell2loc_env/lib/python3.9/site-packages/scvi/_settings.py:70: UserWarning: Setting `dl_pin_memory_gpu_training` is deprecated in v1.0 and will be removed in v1.1. Please pass in `pin_memory` to the data loaders instead.\n  self.dl_pin_memory_gpu_training = (\nadata_st = anndata.read_h5ad(\n            filename=\"/mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/adata_st_A1_cell2loc.h5ad\"\n        )\nadata_st\n\nAnnData object with n_obs × n_vars = 4961 × 15619\n    obs: 'in_tissue', 'array_row', 'array_col', 'n_genes_by_counts', 'log1p_n_genes_by_counts', 'total_counts', 'log1p_total_counts', 'total_counts_mt', 'log1p_total_counts_mt', 'pct_counts_mt', 'total_counts_hb', 'log1p_total_counts_hb', 'pct_counts_hb', '_indices', '_scvi_batch', '_scvi_labels', 'Alveolar', 'Alveolar Mac', 'CAF', 'CD4+ Treg', 'CD8+ Tem', 'CDKN2A Cancer', 'CXCL1 Cancer', 'Ciliated', 'Endothelial', 'LAMC2 Cancer', 'Lipid-associated Mac', 'Low quality Mac', 'Mast', 'Mature naive B', 'Monocytes', 'NK', 'Naive T', 'Neutrophils', 'Pathological Alveolar', 'Plasma', 'Proliferating Cancer', 'Proliferating Mac', 'Proliferating T/NK', 'SMC', 'SOX2 Cancer', 'cDC2/moDCs', 'pDCs'\n    var: 'gene_ids', 'feature_types', 'genome', 'mt', 'hb', 'n_cells_by_counts', 'mean_counts', 'log1p_mean_counts', 'pct_dropout_by_counts', 'total_counts', 'log1p_total_counts', 'n_cells', 'feature_name', 'MT_gene'\n    uns: '_scvi_manager_uuid', '_scvi_uuid', 'mod', 'spatial'\n    obsm: 'MT', 'means_cell_abundance_w_sf', 'q05_cell_abundance_w_sf', 'q95_cell_abundance_w_sf', 'spatial', 'stds_cell_abundance_w_sf'\n    layers: 'logcounts'\n#slide = c2l.utils.select_slide(adata_st, “Visium_FFPE_A1”, batch_key=“patient_region_id”)\nwith mpl.rc_context({“figure.figsize”: [4.5, 5]}): sc.pl.spatial(adata_st, #slide, cmap=“magma”, color=adata_st.uns[“mod”][“factor_names”], ncols=4, size=1.3, img_key=“hires”, # limit color scale at 99.2% quantile of cell abundance vmin=0, vmax=“p99.2”, )"
  },
  {
    "objectID": "Advance/cell2loc_A1_downstream.html#identifying-discrete-tissue-regions-by-leiden-clustering",
    "href": "Advance/cell2loc_A1_downstream.html#identifying-discrete-tissue-regions-by-leiden-clustering",
    "title": "select one slide for visualization",
    "section": "Identifying discrete tissue regions by Leiden clustering",
    "text": "Identifying discrete tissue regions by Leiden clustering\nThe number of KNN neighbours should be adapted to size of dataset and the size of anatomically defined regions\n\n# compute KNN using the cell2location output stored in adata.obsm\nsc.pp.neighbors(adata_st, use_rep='q05_cell_abundance_w_sf',\n                n_neighbors = 15)\n\n# Cluster spots into regions using scanpy\nsc.tl.leiden(adata_st, resolution=1.1)\n\n# add region as categorical variable\nadata_st.obs[\"region_cluster\"] = adata_st.obs[\"leiden\"].astype(\"category\")\n\ncomputing neighbors\n    finished: added to `.uns['neighbors']`\n    `.obsp['distances']`, distances for each pair of neighbors\n    `.obsp['connectivities']`, weighted adjacency matrix (0:00:03)\nrunning Leiden clustering\n    finished: found 15 clusters and added\n    'leiden', the cluster labels (adata.obs, categorical) (0:00:01)\n\n\nWe can use the location composition similarity graph to build a joint integrated UMAP representation of all section/Visium batches.\n\nadata_st.obs[\"sample\"] = \"Visium_FFPE_A1\"\n\n\n# Now we use cell2location plotter that allows showing multiple cell types in one panel\nfrom cell2location.plt import plot_spatial\n\n# select up to 6 clusters\nclust_labels = ['CDKN2A Cancer', 'CXCL1 Cancer', 'CD4+ Treg', 'CD8+ Tem']\nclust_col = ['' + str(i) for i in clust_labels] # in case column names differ from labels\n\n#slide = select_slide(adata_vis, 'V1_Human_Lymph_Node')\n\nwith mpl.rc_context({'figure.figsize': (15, 15)}):\n    fig = plot_spatial(\n        adata=adata_st,\n        # labels to show on a plot\n        color=clust_col, labels=clust_labels,\n        show_img=True,\n        # 'fast' (white background) or 'dark_background'\n        style='fast',\n        # limit color scale at 99.2% quantile of cell abundance\n        max_color_quantile=0.992,\n        # size of locations (adjust depending on figure size)\n        circle_diameter=6,\n        colorbar_position='right'\n    )\n\n\n\n\n\n# compute UMAP using KNN graph based on the cell2location output\nsc.tl.umap(adata_st, min_dist = 0.3, spread = 1)\n\n# show regions in UMAP coordinates\nwith mpl.rc_context({'axes.facecolor':  'white',\n                     'figure.figsize': [8, 8]}):\n    sc.pl.umap(adata_st, color=['region_cluster'], size=30,\n               color_map = 'RdPu', ncols = 2, legend_loc='on data',\n               legend_fontsize=20)\n    sc.pl.umap(adata_st, color=['sample'], size=30,\n               color_map = 'RdPu', ncols = 2,\n               legend_fontsize=20)\n\n# plot in spatial coordinates\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [8, 8]}):\n    sc.pl.spatial(adata_st, color=['region_cluster'],\n                  size=1.3, img_key='hires', alpha=1, bw=True)\n\ncomputing UMAP\n    finished: added\n    'X_umap', UMAP coordinates (adata.obsm) (0:00:07)"
  },
  {
    "objectID": "Advance/cell2loc_A1_downstream.html#subset-regions-of-specific-cell-type",
    "href": "Advance/cell2loc_A1_downstream.html#subset-regions-of-specific-cell-type",
    "title": "select one slide for visualization",
    "section": "Subset regions of specific cell-type",
    "text": "Subset regions of specific cell-type\n\nregion_cluster_9_11_12 = adata_st[(adata_st.obs['region_cluster'] == \"9\") | \n                            (adata_st.obs['region_cluster'] == \"11\") |\n                            (adata_st.obs['region_cluster'] == \"12\")\n                            ] \n\n\n# plot in spatial coordinates\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [8, 8]}):\n    sc.pl.spatial(region_cluster_9_11_12, color=['region_cluster'],\n                  size=1.3, img_key='hires', alpha=1, bw=True,\n                  crop_coord=[300, 1500, 1000, 3000]\n                  #crop_coord=[1500, 500, 1500, 500]\n                  )\n\n\n\n\n\n# plot in spatial coordinates\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [8, 8]}):\n    sc.pl.spatial(region_cluster_9, color=['region_cluster'],\n                  size=1.3, img_key='hires', alpha=1, bw=True,\n                  crop_coord=[300, 1000, 1000, 2400]\n                  #crop_coord=[1500, 500, 1500, 500]\n                  )"
  },
  {
    "objectID": "Advance/cell2loc_A1_downstream.html#visualizing-marker-genes",
    "href": "Advance/cell2loc_A1_downstream.html#visualizing-marker-genes",
    "title": "select one slide for visualization",
    "section": "Visualizing marker genes",
    "text": "Visualizing marker genes\n\nimport scanpy as sc\nimport pandas as pd\nfrom matplotlib import rcParams\n\n\n#sc.set_figure_params(dpi=80, color_map='viridis')\n#sc.settings.verbosity = 2\n#sc.logging.print_versions()\n\n\n## marker genes\nmarker_genes = [\"THEMIS\",\"CD8A\", \"SELL\", \"IL7R\"]\n\n\nadata_st.layers['rawcounts'] = adata_st.X\n\n\nsc.pl.violin(adata_st, marker_genes, \n            groupby='region_cluster',\n            layer='logcounts'\n)\n\n\n\n\n\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [10, 10]}):\n    ax = sc.pl.stacked_violin(adata_st, marker_genes, \n                              groupby='region_cluster',\n                              layer='logcounts'\n                              #log=True,\n                            #color=['region_cluster']\n                            #var_group_positions=9, var_group_labels=['CD8+ Tem']\n                            )\n\n\n\n\n\nCancer markers\n\n## marker genes\ncancer_marker_genes = [\"KRT7\",\"TTF1\", \"KRT16\", \"KRT17\", \"IL12B\", \"KRT5\", \"TP63\", \"NAPSA\"]\n\n\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [10, 10]}):\n    ax = sc.pl.stacked_violin(adata_st, cancer_marker_genes, \n                              groupby='region_cluster',\n                              layer='logcounts'\n                              #log=True,\n                            #color=['region_cluster']\n                            #var_group_positions=9, var_group_labels=['CD8+ Tem']\n                            )\n\n\n\n\n\nregion_cluster_1_3_8_12 = adata_st[(adata_st.obs['region_cluster'] == \"1\") | \n                            (adata_st.obs['region_cluster'] == \"3\") |\n                            (adata_st.obs['region_cluster'] == \"8\") |\n                            (adata_st.obs['region_cluster'] == \"12\")\n                            ] \n\n\n# plot in spatial coordinates\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [8, 8]}):\n    sc.pl.spatial(region_cluster_1_3_8_12, color=['region_cluster'],\n                  size=1.3, img_key='hires', alpha=1, bw=True,\n                  #crop_coord=[300, 1500, 1000, 3000]\n                  #crop_coord=[1500, 500, 1500, 500]\n                  )\n\n\n\n\n\n\nCICs marker\n\ncic_marker_genes_1 = [\"NET1\", \"ALDH3A1\", \"PLAT\", \"GALNT5\"] \ncic_marker_genes_2 = [\"FAM3C\", \"DHRS2\" , \"AQP3\", \"KRT23\" , \"SYT8\"] # , \"HLA-B\"\n\n\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [10, 10]}):\n    ax = sc.pl.stacked_violin(adata_st, cic_marker_genes, \n                              groupby='region_cluster',\n                              layer='logcounts'\n                              #log=True,\n                            #color=['region_cluster']\n                            #var_group_positions=9, var_group_labels=['CD8+ Tem']\n                            )\n\n\n\n\n\nsc.pl.violin(adata_st, cic_marker_genes_2, \n            groupby='region_cluster',\n            layer='logcounts'\n)\n\n\n\n\n\nregion_cluster_8_9_11_12 = adata_st[(adata_st.obs['region_cluster'] == \"8\") | \n                            (adata_st.obs['region_cluster'] == \"9\") |\n                            (adata_st.obs['region_cluster'] == \"11\") |\n                            (adata_st.obs['region_cluster'] == \"12\")\n                            ] \n\n\n# plot in spatial coordinates\nwith mpl.rc_context({'axes.facecolor':  'black',\n                     'figure.figsize': [8, 8]}):\n    sc.pl.spatial(region_cluster_8_9_11_12, color=['region_cluster'],\n                  size=1.3, img_key='hires', alpha=1, bw=True,\n                  #crop_coord=[300, 1500, 1000, 3000]\n                  #crop_coord=[1500, 500, 1500, 500]\n                  )"
  },
  {
    "objectID": "Advance/cell2loc_A1_downstream.html#colocation",
    "href": "Advance/cell2loc_A1_downstream.html#colocation",
    "title": "select one slide for visualization",
    "section": "Colocation",
    "text": "Colocation\n\nresults_folder=\"/mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data\"\nrun_name = f'{results_folder}/cell2location_map'\n\n\nfrom cell2location import run_colocation\nres_dict, adata_st = run_colocation(\n    adata_st,\n    model_name='CoLocatedGroupsSklearnNMF',\n    train_args={\n      'n_fact': np.arange(5, 30), # IMPORTANT: use a wider range of the number of factors (5-30)\n      'sample_name_col': 'sample', # columns in adata_vis.obs that identifies sample\n      'n_restarts': 3 # number of training restarts\n    },\n    # the hyperparameters of NMF can be also adjusted:\n    model_kwargs={'alpha': 0.01, 'init': 'random', \"nmf_kwd_args\": {\"tol\": 0.000001}},\n    export_args={'path': f'{run_name}/CoLocatedComb/'}\n)\n\n### Analysis name: CoLocatedGroupsSklearnNMF_5combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact5_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_6combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact6_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_7combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact7_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_8combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact8_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_9combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact9_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_10combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact10_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_11combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact11_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_12combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact12_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_13combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact13_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_14combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact14_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_15combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact15_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_16combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact16_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_17combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact17_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_18combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact18_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_19combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact19_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_20combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact20_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_21combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact21_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_22combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact22_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_23combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact23_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_24combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact24_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_25combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact25_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_26combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact26_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_27combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact27_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_28combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact28_sVisium_FFPE_A1_p99.2.pdf\n### Analysis name: CoLocatedGroupsSklearnNMF_29combinations_4961locations_27factors\nWARNING: saving figure to file /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/cell2location_map/CoLocatedComb/CoLocatedGroupsSklearnNMF_4961locations_27factors/spatial/showcell_density_mean_n_fact29_sVisium_FFPE_A1_p99.2.pdf\n\n\n\n# Here we plot the NMF weights (Same as saved to `cell_type_fractions_heatmap`)\nres_dict['n_fact5']['mod'].plot_cell_type_loadings()\n\nNameError: name 'res_dict' is not defined\n\n\n\nEstimate cell-type specific expression of every gene in the spatial data (needed for NCEM)\n\nLoad model\n\nmod = c2l.models.RegressionModel.load(f\"/mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data\", adata_st)\n\nINFO     File /mnt/rdisk/duydao/PROJECT/SPATIAL/cell2loc_data/model.pt already downloaded                          \n\n\nValueError: counts is not a valid key in adata.layers.\n\n\n\nadata_st\n\nAnnData object with n_obs × n_vars = 4961 × 15619\n    obs: 'in_tissue', 'array_row', 'array_col', 'n_genes_by_counts', 'log1p_n_genes_by_counts', 'total_counts', 'log1p_total_counts', 'total_counts_mt', 'log1p_total_counts_mt', 'pct_counts_mt', 'total_counts_hb', 'log1p_total_counts_hb', 'pct_counts_hb', '_indices', '_scvi_batch', '_scvi_labels', 'Alveolar', 'Alveolar Mac', 'CAF', 'CD4+ Treg', 'CD8+ Tem', 'CDKN2A Cancer', 'CXCL1 Cancer', 'Ciliated', 'Endothelial', 'LAMC2 Cancer', 'Lipid-associated Mac', 'Low quality Mac', 'Mast', 'Mature naive B', 'Monocytes', 'NK', 'Naive T', 'Neutrophils', 'Pathological Alveolar', 'Plasma', 'Proliferating Cancer', 'Proliferating Mac', 'Proliferating T/NK', 'SMC', 'SOX2 Cancer', 'cDC2/moDCs', 'pDCs', 'leiden', 'region_cluster', 'sample'\n    var: 'gene_ids', 'feature_types', 'genome', 'mt', 'hb', 'n_cells_by_counts', 'mean_counts', 'log1p_mean_counts', 'pct_dropout_by_counts', 'total_counts', 'log1p_total_counts', 'n_cells', 'feature_name', 'MT_gene'\n    uns: '_scvi_manager_uuid', '_scvi_uuid', 'mod', 'spatial', 'neighbors', 'leiden', 'umap', 'region_cluster_colors', 'sample_colors'\n    obsm: 'MT', 'means_cell_abundance_w_sf', 'q05_cell_abundance_w_sf', 'q95_cell_abundance_w_sf', 'spatial', 'stds_cell_abundance_w_sf', 'X_umap'\n    layers: 'logcounts'\n    obsp: 'distances', 'connectivities'\n\n\n\nimport matplotlib.pyplot as plt\nimport scanpy as sc\nimport numpy as np\n\n\ndef plot_genes_per_cell_type(slide, genes, ctypes):\n    n_genes = len(genes)\n    n_ctypes = len(ctypes)\n    fig, axs = plt.subplots(\n        nrows=n_genes, ncols=n_ctypes + 1, figsize=(4.5 * (n_ctypes + 1) + 2, 5 * n_genes + 1), squeeze=False\n    )\n    # axs = axs.reshape((n_genes, n_ctypes+1))\n\n    # plots of every gene\n    for j in range(n_genes):\n        # limit color scale at 99.2% quantile of gene expression (computed across cell types)\n        quantile_across_ct = np.array(\n            [\n                np.quantile(slide.layers[n][:, slide.var[\"feature_name\"] == genes[j]].toarray(), 0.992)\n                for n in slide.uns[\"mod\"][\"factor_names\"]\n            ]\n        )\n        quantile_across_ct = np.partition(quantile_across_ct.flatten(), -2)[-2]\n        sc.pl.spatial(\n            slide,\n            cmap=\"magma\",\n            color=genes[j],\n            # layer=ctypes[i],\n            gene_symbols=\"feature_name\",\n            ncols=4,\n            size=1.3,\n            img_key=\"hires\",\n            # limit color scale at 99.2% quantile of gene expression\n            vmin=0,\n            vmax=\"p99.2\",\n            ax=axs[j, 0],\n            show=False,\n        )\n\n        # plots of every cell type\n        for i in range(n_ctypes):\n            sc.pl.spatial(\n                slide,\n                cmap=\"magma\",\n                color=genes[j],\n                layer=ctypes[i],\n                gene_symbols=\"feature_name\",\n                ncols=4,\n                size=1.3,\n                img_key=\"hires\",\n                # limit color scale at 99.2% quantile of gene expression\n                vmin=0,\n                vmax=quantile_across_ct,\n                ax=axs[j, i + 1],\n                show=False,\n            )\n            axs[j, i + 1].set_title(f\"{genes[j]} {ctypes[i]}\")\n\n    return fig, axs\n\nAttributeError: 'dict' object has no attribute 'samples'\n\n\n\n# Compute expected expression per cell type\nexpected_dict = mod.module.model.compute_expected_per_cell_type(\n    mod.samples[\"post_sample_q05\"], mod.adata_manager\n)\n\n# Add to anndata layers\nfor i, n in enumerate(mod.factor_names_):\n    adata_st.layers[n] = expected_dict['mu'][i]\n\n# Save anndata object with results\nadata_file = f\"{run_name}/adata_st_est_celltype_specific_expression_A1.h5ad\"\nadata_st.write(adata_file)\nadata_file\n\nAttributeError: 'dict' object has no attribute 'module'\n\n\n\n# list cell types and genes for plotting\nctypes = [\"SOX2 Cancer\", \"CXCL1 Cancer\", \"CD8+ Tem\"]\ngenes = ['CD3D', 'THEMIS']\n\nwith mpl.rc_context({'axes.facecolor':  'black'}):\n    # select one slide\n    #slide = select_slide(adata_st, 'V1_Human_Lymph_Node')\n\n    #from tutorial_utils import plot_genes_per_cell_type\n    plot_genes_per_cell_type(adata_st, genes, ctypes);"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this site\n\n\n\n Back to top"
  },
  {
    "objectID": "Basic/menu2.html",
    "href": "Basic/menu2.html",
    "title": "Basic2",
    "section": "",
    "text": "About this site\n\n\n\n Back to top"
  },
  {
    "objectID": "tutorial-2.html",
    "href": "tutorial-2.html",
    "title": "Tutorial 2",
    "section": "",
    "text": "What is Lorem Ipsum?\nLorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry’s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.\n\n\nWhy do we use it?\nIt is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English. Many desktop publishing packages and web page editors now use Lorem Ipsum as their default model text, and a search for ‘lorem ipsum’ will uncover many web sites still in their infancy. Various versions have evolved over the years, sometimes by accident, sometimes on purpose (injected humour and the like).\n\n\nWhere does it come from?\nContrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old. Richard McClintock, a Latin professor at Hampden-Sydney College in Virginia, looked up one of the more obscure Latin words, consectetur, from a Lorem Ipsum passage, and going through the cites of the word in classical literature, discovered the undoubtable source. Lorem Ipsum comes from sections 1.10.32 and 1.10.33 of “de Finibus Bonorum et Malorum” (The Extremes of Good and Evil) by Cicero, written in 45 BC. This book is a treatise on the theory of ethics, very popular during the Renaissance. The first line of Lorem Ipsum, “Lorem ipsum dolor sit amet..”, comes from a line in section 1.10.32.\nThe standard chunk of Lorem Ipsum used since the 1500s is reproduced below for those interested. Sections 1.10.32 and 1.10.33 from “de Finibus Bonorum et Malorum” by Cicero are also reproduced in their exact original form, accompanied by English versions from the 1914 translation by H. Rackham.\n\n\n\n\n Back to top"
  },
  {
    "objectID": "reference.html",
    "href": "reference.html",
    "title": "khuongduying",
    "section": "",
    "text": "Back to top"
  },
  {
    "objectID": "fundamentals.html",
    "href": "fundamentals.html",
    "title": "khuongduying",
    "section": "",
    "text": "Back to top"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "quarto_website",
    "section": "",
    "text": "This is a Duy’s Quarto website.\nTo learn more about Quarto websites visit https://quarto.org/docs/websites."
  },
  {
    "objectID": "index.html#workflow",
    "href": "index.html#workflow",
    "title": "quarto_website",
    "section": "Workflow",
    "text": "Workflow\n\nConfig File\nEvery website has a _quarto.yml config file that provides website options as well as defaults for HTML documents created within the site. For example, here is the default config file for the simple site created above:\nproject:\n    type: website\n\nwebsite:\n    title: \"today\"\n    navbar:\n        left:\n            - href: index.qmd\n        text: Home\n            - about.qmd\n\nformat:\n    html:\n        theme: cosmo\n        css: styles.css\n        toc: true"
  },
  {
    "objectID": "index.html#why-do-we-use-it",
    "href": "index.html#why-do-we-use-it",
    "title": "quarto_website",
    "section": "Why do we use it?",
    "text": "Why do we use it?\nIt is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English. Many desktop publishing packages and web page editors now use Lorem Ipsum as their default model text, and a search for ‘lorem ipsum’ will uncover many web sites still in their infancy. Various versions have evolved over the years, sometimes by accident, sometimes on purpose (injected humour and the like)."
  },
  {
    "objectID": "index.html#where-can-i-get-some",
    "href": "index.html#where-can-i-get-some",
    "title": "quarto_website",
    "section": "Where can I get some?",
    "text": "Where can I get some?\nThere are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don’t look even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn’t anything embarrassing hidden in the middle of text. All the Lorem Ipsum generators on the Internet tend to repeat predefined chunks as necessary, making this the first true generator on the Internet. It uses a dictionary of over 200 Latin words, combined with a handful of model sentence structures, to generate Lorem Ipsum which looks reasonable. The generated Lorem Ipsum is therefore always free from repetition, injected humour, or non-characteristic words etc."
  },
  {
    "objectID": "howto.html",
    "href": "howto.html",
    "title": "khuongduying",
    "section": "",
    "text": "Back to top"
  },
  {
    "objectID": "news.html",
    "href": "news.html",
    "title": "News",
    "section": "",
    "text": "Recently added page.\nViết thử tiếng Việt xem sao\n\n\n\n Back to top"
  },
  {
    "objectID": "Basic/menu1.html",
    "href": "Basic/menu1.html",
    "title": "Basic1",
    "section": "",
    "text": "About this site\n\n\n\n Back to top"
  },
  {
    "objectID": "tutorial-1.html",
    "href": "tutorial-1.html",
    "title": "Tutorial 1",
    "section": "",
    "text": "What is Lorem Ipsum?\nLorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry’s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.\n\n\nWhy do we use it?\nIt is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English. Many desktop publishing packages and web page editors now use Lorem Ipsum as their default model text, and a search for ‘lorem ipsum’ will uncover many web sites still in their infancy. Various versions have evolved over the years, sometimes by accident, sometimes on purpose (injected humour and the like).\n\n\nWhere does it come from?\nContrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old. Richard McClintock, a Latin professor at Hampden-Sydney College in Virginia, looked up one of the more obscure Latin words, consectetur, from a Lorem Ipsum passage, and going through the cites of the word in classical literature, discovered the undoubtable source. Lorem Ipsum comes from sections 1.10.32 and 1.10.33 of “de Finibus Bonorum et Malorum” (The Extremes of Good and Evil) by Cicero, written in 45 BC. This book is a treatise on the theory of ethics, very popular during the Renaissance. The first line of Lorem Ipsum, “Lorem ipsum dolor sit amet..”, comes from a line in section 1.10.32.\nThe standard chunk of Lorem Ipsum used since the 1500s is reproduced below for those interested. Sections 1.10.32 and 1.10.33 from “de Finibus Bonorum et Malorum” by Cicero are also reproduced in their exact original form, accompanied by English versions from the 1914 translation by H. Rackham.\n\n\nWhat is Lorem Ipsum?\nLorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry’s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.\n\n\nWhy do we use it?\nIt is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English. Many desktop publishing packages and web page editors now use Lorem Ipsum as their default model text, and a search for ‘lorem ipsum’ will uncover many web sites still in their infancy. Various versions have evolved over the years, sometimes by accident, sometimes on purpose (injected humour and the like).\n\n\nWhere does it come from?\nContrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old. Richard McClintock, a Latin professor at Hampden-Sydney College in Virginia, looked up one of the more obscure Latin words, consectetur, from a Lorem Ipsum passage, and going through the cites of the word in classical literature, discovered the undoubtable source. Lorem Ipsum comes from sections 1.10.32 and 1.10.33 of “de Finibus Bonorum et Malorum” (The Extremes of Good and Evil) by Cicero, written in 45 BC. This book is a treatise on the theory of ethics, very popular during the Renaissance. The first line of Lorem Ipsum, “Lorem ipsum dolor sit amet..”, comes from a line in section 1.10.32.\nThe standard chunk of Lorem Ipsum used since the 1500s is reproduced below for those interested. Sections 1.10.32 and 1.10.33 from “de Finibus Bonorum et Malorum” by Cicero are also reproduced in their exact original form, accompanied by English versions from the 1914 translation by H. Rackham.\n\n\n\n\n Back to top"
  },
  {
    "objectID": "Advance/menu4.html",
    "href": "Advance/menu4.html",
    "title": "Advance2",
    "section": "",
    "text": "About this site\n\n\n\n Back to top"
  },
  {
    "objectID": "Advance/menu3.html",
    "href": "Advance/menu3.html",
    "title": "Advance1",
    "section": "",
    "text": "About this site\n\n\n\n Back to top"
  }
]